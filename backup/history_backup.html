<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - Auto-Summarizer</title>
    
    <!-- Prevent FOUC by setting theme immediately -->
    <script>
        // On page load or when changing themes, best to add inline in head to avoid FOUC
        document.documentElement.classList.toggle(
            "dark",
            localStorage.theme === "dark" ||
            (!("theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)
        );
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://rsms.me/inter/inter.css');
        
        /* Dark mode toggle */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgb(255 255 255 / 1);
            border: 1px solid rgb(226 232 240 / 1);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .dark .dark-mode-toggle {
            background-color: rgb(30 41 59 / 1);
            border-color: rgb(51 65 85 / 1);
            color: rgb(241 245 249 / 1);
        }
        
        .dark-mode-toggle:hover {
            background-color: rgb(248 250 252 / 1);
        }
        
        .dark .dark-mode-toggle:hover {
            background-color: rgb(51 65 85 / 1);
        }
        
        .tab-button { cursor: pointer; transition: all 0.2s ease-in-out; }
        .tab-content { max-height: 400px; overflow-y: auto; }
        .job-card { 
            transition: all 0.2s ease-in-out; 
        }
        .job-card:hover { 
            transform: translateY(-2px); 
        }
        .status-badge { 
            display: inline-flex; 
            align-items: center; 
            padding: 0.125rem 0.625rem; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
            font-weight: 500; 
        }
        .status-completed { background-color: #dcfce7; color: #166534; }
        .status-failed { background-color: #fee2e2; color: #991b1b; }
        .status-processing { background-color: #fef3c7; color: #92400e; }
        
        .dark .status-completed { background-color: #1f3a23; color: #86efac; }
        .dark .status-failed { background-color: #3a1f1f; color: #fca5a5; }
        .dark .status-processing { background-color: #3a2f1f; color: #fbbf24; }
        
        /* Copy button styles */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s ease;
        }
        
        .copy-btn:hover {
            opacity: 1;
        }
        
        .copy-btn.copied {
            background-color: #10b981;
            color: white;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen transition-colors">
    <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" id="dark-mode-toggle" title="Toggle dark mode">
        <svg id="sun-icon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <svg id="moon-icon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
    </button>
    <div class="w-full max-w-6xl mx-auto p-4 sm:p-8">
        <!-- Navigation Bar -->
        <nav class="mb-8">
            <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-1 transition-colors">
                <div class="flex space-x-1">
                    <a href="/" class="flex-1 text-center py-2 px-4 rounded-md text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-slate-100 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all duration-200">
                        Upload
                    </a>
                    <span class="flex-1 text-center py-2 px-4 rounded-md text-sm font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 transition-all duration-200">
                        History
                    </span>
                    <a href="/settings" class="flex-1 text-center py-2 px-4 rounded-md text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-slate-100 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all duration-200">
                        Settings
                    </a>
                </div>
            </div>
        </nav>
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100">Job History</h1>
            <p class="text-slate-600 dark:text-slate-300 mt-2">View all your previous summarization jobs and results.</p>
        </header>

        <main class="bg-white dark:bg-slate-800 rounded-xl shadow-lg transition-colors">
            <!-- Search and Filter Bar -->
            <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Search jobs..." 
                            class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                        >
                    </div>
                    <div class="flex gap-2">
                        <select id="status-filter" class="px-4 py-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                            <option value="">All Status</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="FAILED">Failed</option>
                            <option value="PROCESSING">Processing</option>
                        </select>
                        <button id="refresh-btn" class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="p-8 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-slate-600 dark:text-slate-300">Loading job history...</p>
            </div>

            <!-- Error State -->
            <div id="error" class="hidden p-8 text-center">
                <div class="text-red-600 dark:text-red-400 mb-4">
                    <svg class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                </div>
                <p class="text-slate-600 dark:text-slate-300" id="error-message">Failed to load job history.</p>
                <button onclick="loadHistory()" class="mt-4 px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
                    Try Again
                </button>
            </div>

            <!-- Empty State -->
            <div id="empty" class="hidden p-8 text-center">
                <div class="text-slate-400 dark:text-slate-500 mb-4">
                    <svg class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
                <p class="text-slate-600 dark:text-slate-300 mb-4">No jobs found.</p>
                <a href="/" class="px-4 py-2 bg-blue-600 dark:bg-blue-700 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
                    Create Your First Summary
                </a>
            </div>

            <!-- Jobs List -->
            <div id="jobs-container" class="hidden">
                <div id="jobs-list" class="divide-y divide-slate-200 dark:divide-slate-700">
                    <!-- Jobs will be populated here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Job Detail Modal -->
    <div id="job-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden transition-colors">
            <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-100">Job Details</h2>
                    <button id="close-modal" class="text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <!-- Job Info -->
                <div class="mb-6">
                    <div class="flex items-center gap-4 mb-2">
                        <span class="text-sm text-slate-500 dark:text-slate-400">Job ID:</span>
                        <span id="modal-job-id" class="text-sm font-mono text-slate-900 dark:text-slate-100"></span>
                        <span id="modal-status" class="status-badge"></span>
                    </div>
                    <div class="text-sm text-slate-500 dark:text-slate-400" id="modal-created-at"></div>
                </div>

                <!-- Tab Navigation -->
                <div class="border-b border-slate-200 dark:border-slate-700 mb-4">
                    <nav class="-mb-px flex space-x-8">
                        <button id="modal-summary-tab" class="tab-button py-2 px-1 border-b-2 border-blue-500 dark:border-blue-400 font-medium text-sm text-blue-600 dark:text-blue-400">
                            Summary
                        </button>
                        <button id="modal-transcript-tab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 hover:border-slate-300 dark:hover:border-slate-600">
                            Transcript
                        </button>
                    </nav>
                </div>
                
                <!-- Tab Content -->
                <div id="modal-summary-content" class="tab-content prose max-w-none relative">
                    <button class="copy-btn bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600" onclick="copyToClipboard('modal-summary-text', this)" title="Copy summary">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <pre id="modal-summary-text" class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-4"></pre>
                </div>
                
                <div id="modal-transcript-content" class="tab-content hidden prose max-w-none relative">
                    <button class="copy-btn bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600" onclick="copyToClipboard('modal-transcript-text', this)" title="Copy transcript">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <pre id="modal-transcript-text" class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-4"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allJobs = [];
        let filteredJobs = [];

        // Dark mode functionality
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        
        // Check if dark mode is enabled
        function isDarkMode() {
            return document.documentElement.classList.contains('dark');
        }
        
        // Update icons based on current theme
        function updateIcons() {
            if (isDarkMode()) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }
        
        // Initialize icons on page load
        updateIcons();
        
        darkModeToggle.addEventListener('click', () => {
            if (isDarkMode()) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
            updateIcons();
        });

        // Copy to clipboard functionality
        function copyToClipboard(elementId, button) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const originalContent = button.innerHTML;
                button.innerHTML = '<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }

        // DOM elements
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const empty = document.getElementById('empty');
        const jobsContainer = document.getElementById('jobs-container');
        const jobsList = document.getElementById('jobs-list');
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const refreshBtn = document.getElementById('refresh-btn');

        // Modal elements
        const jobModal = document.getElementById('job-modal');
        const closeModal = document.getElementById('close-modal');
        const modalSummaryTab = document.getElementById('modal-summary-tab');
        const modalTranscriptTab = document.getElementById('modal-transcript-tab');
        const modalSummaryContent = document.getElementById('modal-summary-content');
        const modalTranscriptContent = document.getElementById('modal-transcript-content');

        // Load history on page load
        document.addEventListener('DOMContentLoaded', loadHistory);

        // Event listeners
        refreshBtn.addEventListener('click', loadHistory);
        searchInput.addEventListener('input', filterJobs);
        statusFilter.addEventListener('change', filterJobs);
        closeModal.addEventListener('click', () => jobModal.classList.add('hidden'));
        jobModal.addEventListener('click', (e) => {
            if (e.target === jobModal) jobModal.classList.add('hidden');
        });

        // Modal tab switching
        modalSummaryTab.addEventListener('click', () => switchModalTab(modalSummaryTab, modalSummaryContent));
        modalTranscriptTab.addEventListener('click', () => switchModalTab(modalTranscriptTab, modalTranscriptContent));

        async function loadHistory() {
            showLoading();
            try {
                const response = await fetch('/api/history');
                if (!response.ok) {
                    throw new Error('Failed to load history');
                }
                const data = await response.json();
                allJobs = data.jobs || [];
                filteredJobs = [...allJobs];
                renderJobs();
            } catch (err) {
                showError(err.message);
            }
        }

        function showLoading() {
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            empty.classList.add('hidden');
            jobsContainer.classList.add('hidden');
        }

        function showError(message) {
            loading.classList.add('hidden');
            error.classList.remove('hidden');
            empty.classList.add('hidden');
            jobsContainer.classList.add('hidden');
            document.getElementById('error-message').textContent = message;
        }

        function showEmpty() {
            loading.classList.add('hidden');
            error.classList.add('hidden');
            empty.classList.remove('hidden');
            jobsContainer.classList.add('hidden');
        }

        function showJobs() {
            loading.classList.add('hidden');
            error.classList.add('hidden');
            empty.classList.add('hidden');
            jobsContainer.classList.remove('hidden');
        }

        function filterJobs() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusTerm = statusFilter.value;

            filteredJobs = allJobs.filter(job => {
                const matchesSearch = !searchTerm || 
                    (job.summary && job.summary.toLowerCase().includes(searchTerm)) ||
                    (job.transcript && job.transcript.toLowerCase().includes(searchTerm)) ||
                    (job.id && job.id.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusTerm || job.status === statusTerm;
                
                return matchesSearch && matchesStatus;
            });

            renderJobs();
        }

        function renderJobs() {
            if (filteredJobs.length === 0) {
                showEmpty();
                return;
            }

            showJobs();
            jobsList.innerHTML = filteredJobs.map(job => createJobCard(job)).join('');
        }

        function createJobCard(job) {
            const statusClass = getStatusClass(job.status);
            const preview = job.summary ? job.summary.substring(0, 150) + '...' : 'No summary available';
            const createdAt = job.id ? new Date(parseInt(job.id.split('-')[0]) || Date.now()).toLocaleString() : 'Unknown';

            return `
                <div class="job-card p-6 cursor-pointer bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 border-b border-slate-200 dark:border-slate-700 transition-colors" onclick="openJobModal('${job.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <span class="status-badge ${statusClass}">${job.status}</span>
                            <span class="text-sm text-slate-500 dark:text-slate-400">${createdAt}</span>
                        </div>
                        <button class="text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <div class="text-sm text-slate-600 dark:text-slate-300">
                        <strong>Job ID:</strong> <span class="font-mono">${job.id}</span>
                    </div>
                    <div class="mt-3 text-sm text-slate-700 dark:text-slate-300">
                        ${preview}
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'COMPLETED': return 'status-completed';
                case 'FAILED': return 'status-failed';
                case 'PROCESSING': return 'status-processing';
                default: return 'status-processing';
            }
        }

        function openJobModal(jobId) {
            const job = allJobs.find(j => j.id === jobId);
            if (!job) return;

            // Populate modal
            document.getElementById('modal-job-id').textContent = job.id;
            document.getElementById('modal-status').textContent = job.status;
            document.getElementById('modal-status').className = `status-badge ${getStatusClass(job.status)}`;
            document.getElementById('modal-created-at').textContent = 
                'Created: ' + (job.id ? new Date(parseInt(job.id.split('-')[0]) || Date.now()).toLocaleString() : 'Unknown');
            
            document.getElementById('modal-summary-text').textContent = job.summary || 'No summary available';
            document.getElementById('modal-transcript-text').textContent = job.transcript || 'No transcript available';

            // Show modal and default to summary tab
            jobModal.classList.remove('hidden');
            switchModalTab(modalSummaryTab, modalSummaryContent);
        }

        function switchModalTab(activeTab, activeContent) {
            // Reset all tabs
            [modalSummaryTab, modalTranscriptTab].forEach(tab => {
                tab.classList.remove('border-blue-500', 'dark:border-blue-400', 'text-blue-600', 'dark:text-blue-400');
                tab.classList.add('border-transparent', 'text-slate-500', 'dark:text-slate-400');
            });
            [modalSummaryContent, modalTranscriptContent].forEach(content => {
                content.classList.add('hidden');
            });
            
            // Activate selected tab
            activeTab.classList.remove('border-transparent', 'text-slate-500', 'dark:text-slate-400');
            activeTab.classList.add('border-blue-500', 'dark:border-blue-400', 'text-blue-600', 'dark:text-blue-400');
            activeContent.classList.remove('hidden');
        }
    </script>
</body>
</html>
